#!/bin/bash -e

: ${JMXPORT=9203}

args=()
dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

if [[ -e "$dir/../../helios" ]]; then
    jar="$(ls -t $dir/../target/helios*.jar | grep -v sources | grep -v javadoc | head -n 1)"
    CLASSPATH="$(cd $(dirname $jar) && pwd -P)/$(basename $jar)"
    echo "running in helios project, using $CLASSPATH" 1>&2
else
    CLASSPATH="/usr/share/spotify-helios/lib/*"
fi

if [ $JMXPORT ]; then
    args=("${args[@]}"
          -Dcom.sun.management.jmxremote.port=$JMXPORT
          -Dcom.sun.management.jmxremote.ssl=false
          -Dcom.sun.management.jmxremote.authenticate=false )
fi

if [[ -e /etc/spotify/helios.args ]]; then
    args=("${args[@]}"
          $(cat /etc/spotify/helios.args | grep -v \#) )
fi

exec java \
    "${args[@]}" \
    -Djava.net.preferIPv4Stack=true \
    -cp "$CLASSPATH" \
    com.spotify.helios.agent.AgentMain \
    "$@"
