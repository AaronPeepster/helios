#!/bin/bash
echo Stopping docker
initctl stop docker

## Kill off any running containers
## Try nicely
echo Killing off any running containers gently
killall lxc-start
sleep 10
## Kill with prejudice
echo Killing off any remaining running containers forcefully
killall -9 lxc-start

## Attempt to undo any aufs mounts
echo Undoing any remaining AUFS mounts
for i in $(cat /proc/mounts | grep '/var/lib/docker/aufs' | cut -d' ' -f2)
do
    umount $i
done

## Move all the container stuff out of the way
echo Moving state in /var/lib/docker
cd /var/lib/docker
DIRNAME=crud-$(date +%s)
mkdir $DIRNAME
mv aufs containers graph $DIRNAME

## Flush any iptables routes so we don't conflict when it comes back up
echo Flushing NAT routing tables
for i in PREROUTING INPUT OUTPUT DOCKER POSTROUTING
do
  iptables -tnat -F $i
done

## Start docker back up
echo Starting docker
initctl start docker

## Nuke the old container stuff
echo Attempting to delete old docker state that was moved
rm -rf $DIRNAME # may fail
